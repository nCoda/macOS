#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# -----------------------------------------------------------------------------
# Program Name:           ncoda_osx.travis.yml
# Program Description:    Travis build config file for OS X build.
#
# Filename:               macOS/ncoda_osx.travis.yml
# Purpose:                This tells Travis how to execute the OS X build.
#
# Copyright (C) 2017 Jeff Trevi√±o
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
# -----------------------------------------------------------------------------
notifications: # set notification options
  # disable all email
  email: false

matrix:
    include:
        - os: osx
          language: generic

# run
branches:
  only:
    - main

before_install:
  # - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update          ; fi
  - git clone --recursive https://github.com/nCoda/julius.git julius
  - git clone https://github.com/nCoda/lychee.git lychee
  - git clone https://github.com/nCoda/fujian.git fujian
  - git clone https://github.com/nCoda/mercurial-hug.git mercurial-hug
  - rm julius/js/electron_main.js
  - cp electron_main_production.js julius/js/electron_main.js
  # might need this...
  # - brew link --overwrite node


install:
  - cd julius && npm install
  - cd ..
  - virtualenv ncoda_venv
  - source ncoda_venv/bin/activate
  - cd mercurial-hug && pip install . && cd ..
  - cd lychee && pip install . && cd ..
  - cd fujian && pip install . && cd ..
  # get dmgbuild to automate the dmg packaging
  - pip install dmgbuild
  # get mock and pytest to run the tests
  - pip install pytest
  - pip install mock
  # Use Browserify to compile the JS. And use LESS to compile the CSS.
  - cd julius && node_modules/.bin/browserify js/ncoda-init.js --outfile js/ncoda-compiled.js && cd ..
  - cd julius && node_modules/.bin/lessc css/ncoda/main.less css/ncoda/ main.css && cd ..

script: source build_test.sh

before_deploy:
  - python package_ncoda_macOS.py

deploy:
  provider: releases
  api_key: "GITHUB OAUTH TOKEN"
  file: "FILE TO UPLOAD"
  skip_cleanup: true
  on:
    tags: true

after_deploy:
  - rm -r build